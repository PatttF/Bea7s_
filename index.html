<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bea7s_</title>
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Tone.js for Web Audio -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.js"></script>
    <!-- @tonejs/midi for parsing/writing .mid files -->
    <script src="https://cdn.jsdelivr.net/npm/@tonejs/midi@2.0.28/build/Midi.js"></script>
    <style>
        body { font-family: 'Orbitron', 'Inter', sans-serif; -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale; touch-action: manipulation; }
        .step { transition: all 0.1s ease; position: relative; min-height: 40px; }
        .step.active { background-color: #f59e0b; }
        .step.current { box-shadow: inset 0 0 0 3px #00ffff; } /* Cyan for cyberpunk theme */
        .editor-popup { transition: opacity 0.15s ease-in-out, transform 0.15s ease-in-out; font-family: 'Inter', sans-serif; }
        input[type="file"]::file-selector-button { @apply bg-gray-600 hover:bg-gray-500 text-white font-semibold py-1 px-3 rounded-lg cursor-pointer transition-colors; }
        .ratchet-btn.selected { @apply bg-amber-500 text-white; }
        .effect-btn:active, #beat-repeat-button.active { @apply ring-2 ring-amber-400 transform scale-95; }
        
        #record-button.recording { @apply bg-red-600 ring-2 ring-red-400; }
    </style>
     <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=Orbitron:wght@400..900&display=swap" rel="stylesheet">
</head>
<body class="bg-gray-800 text-white flex items-center justify-center min-h-screen p-2 sm:p-4">

    <!-- Startup Modal -->
    <div id="startup-modal" class="absolute inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 cursor-pointer">
        <div class="text-center p-4">
            <h2 class="text-3xl font-bold mb-4">Welcome to Bea7s_</h2>
            <p class="mb-2 text-gray-300 font-sans">Click the button to start, then:</p>
            <ul class="text-left max-w-md mx-auto list-disc list-inside text-gray-400 font-sans space-y-1 mb-6">
                <li>Built-in synths play by default.</li>
                <li>Load a .wav file to replace a synth.</li>
                <li>Click a square to toggle a note.</li>
                <li>Click &amp; hold a note to edit velocity/ratchet.</li>
                <li>Click the track icon for options.</li>
                 <li>Double-click a track name to rename it.</li>
                <li>Use the Record button to play in a beat via MIDI.</li>
            </ul>
            <button id="start-button" class="bg-indigo-500 hover:bg-indigo-600 text-white font-bold py-3 px-6 rounded-lg text-xl shadow-lg transition-transform transform hover:scale-105">Start</button>
        </div>
    </div>

    <!-- Main Sequencer Container -->
    <div id="sequencer-container" class="w-full max-w-7xl bg-gray-900 rounded-2xl shadow-2xl p-4 sm:p-6 hidden relative">
        <div class="flex flex-col items-center justify-center mb-6">
            <!-- Cyberpunk Logo -->
            <svg width="150" height="70" viewBox="-30 -15 210 100">
                <defs>
                    <linearGradient id="cyberGradient" x1="0%" y1="0%" x2="100%" y2="100%"><stop offset="0%" style="stop-color:#00ffff;"/><stop offset="100%" style="stop-color:#ff00ff;"/></linearGradient>
                    <filter id="glitch"><feTurbulence type="fractalNoise" baseFrequency="0.1" numOctaves="1" result="turbulence"/><feDisplacementMap in="SourceGraphic" in2="turbulence" scale="3" xChannelSelector="R" yChannelSelector="G"/></filter>
                </defs>
                <text x="75" y="35" dominant-baseline="middle" text-anchor="middle" font-size="50" font-weight="900" fill="url(#cyberGradient)" style="letter-spacing: -2px;">BEA<tspan fill="#ff00ff" style="filter: url(#glitch);">7</tspan>S_</text>
                 <text x="75" y="35" dominant-baseline="middle" text-anchor="middle" font-size="50" font-weight="900" fill="url(#cyberGradient)" style="letter-spacing: -2px; mix-blend-mode: screen; opacity: 0.8; transform: translateX(2px)">BEA<tspan fill="#00ffff" style="filter: url(#glitch);">7</tspan>S_</text>
            </svg>
        </div>

        <div class="flex flex-col md:flex-row items-center justify-between gap-4 mb-6 bg-gray-800 p-4 rounded-lg">
            <div class="flex items-center gap-4 flex-wrap justify-center">
                <button id="record-button" title="Arm for MIDI Recording" class="bg-gray-600 hover:bg-gray-500 p-2 rounded-full transition-colors"><svg class="w-6 h-6 text-white" fill="currentColor" viewBox="0 0 20 20"><path d="M10 18a8 8 0 100-16 8 8 0 000 16z"/></svg></button>
                <button id="play-stop-button" class="bg-green-500 hover:bg-green-600 text-white font-semibold py-1 px-3 rounded-lg transition-colors">Play</button>
                <button id="beat-repeat-button" class="effect-btn bg-indigo-500 hover:bg-indigo-600 text-white font-semibold py-1 px-3 rounded-lg transition-colors">Repeat</button>
                <button id="mutate-button" class="effect-btn bg-purple-500 hover:bg-purple-600 text-white font-semibold py-1 px-3 rounded-lg transition-colors">Mutate</button>
                <button id="save-midi-button" class="effect-btn bg-teal-500 hover:bg-teal-600 text-white font-semibold py-1 px-3 rounded-lg transition-colors">Save MIDI</button>
                <button id="load-midi-button" class="effect-btn bg-cyan-500 hover:bg-cyan-600 text-white font-semibold py-1 px-3 rounded-lg transition-colors">Load MIDI</button>
                <input type="file" id="midi-file-input" class="hidden" accept=".mid,.midi">
            </div>
            <div class="flex items-center gap-2">
                <label for="bpm-slider" class="font-medium font-sans">BPM:</label>
                <input type="range" id="bpm-slider" min="60" max="240" value="120" class="w-32 sm:w-48">
                <span id="bpm-display" class="font-mono bg-gray-700 px-2 py-1 rounded w-16 text-center">120</span>
            </div>
        </div>
        
        <div id="sequencer-grid-container"><div id="sequencer-grid" class="grid gap-1" style="grid-template-columns: 140px repeat(16, 1fr);"></div></div>
        
        <!-- Global Effects Section -->
        <div id="effects-section" class="bg-gray-800 p-4 rounded-lg mt-8 font-sans">
            <h2 class="text-xl font-semibold mb-4 text-center text-cyan-400">Global Effects</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                <!-- Vinyl -->
                <div class="bg-gray-700 p-4 rounded-lg space-y-3"><h3 class="font-bold text-center">Vinyl</h3><div class="flex items-center gap-2"><label class="w-20">Drive</label><input type="range" id="vinyl-drive-slider" min="0" max="1" value="0" step="0.01" class="w-full"></div></div>
                <!-- Filter -->
                <div class="bg-gray-700 p-4 rounded-lg space-y-3"><h3 class="font-bold text-center">Filter</h3><div class="flex items-center gap-2"><label class="w-20">Frequency</label><input type="range" id="filter-freq-slider" min="200" max="12000" value="12000" class="w-full"></div><div class="flex items-center gap-2"><label class="w-20">Resonance</label><input type="range" id="filter-res-slider" min="0" max="20" value="0" step="0.1" class="w-full"></div></div>
            </div>
        </div>

        <div class="bg-gray-800 p-4 rounded-lg mt-8 font-sans"><h2 class="text-xl font-semibold mb-3 text-center text-cyan-400">MIDI Settings</h2><div id="midi-status" class="text-center text-sm text-gray-400 mb-4">Initializing MIDI...</div>
            <div class="flex flex-col sm:flex-row justify-around gap-x-6 gap-y-4">
                <div class="flex-1 flex items-end gap-2">
                    <div class="flex-grow"><label for="midi-input-select" class="block mb-1 font-medium">MIDI Input:</label><select id="midi-input-select" class="w-full bg-gray-700 text-white p-2 rounded-lg focus:outline-none focus:ring-2 focus:ring-amber-500"><option>No devices found</option></select></div>
                    <div class="w-24"><label for="midi-input-channel" class="block mb-1 font-medium">Channel:</label><select id="midi-input-channel" class="w-full bg-gray-700 text-white p-2 rounded-lg focus:outline-none focus:ring-2 focus:ring-amber-500"></select></div>
                </div>
                <div class="flex-1 flex items-end gap-2">
                    <div class="flex-grow"><label for="midi-output-select" class="block mb-1 font-medium">MIDI Output:</label><select id="midi-output-select" class="w-full bg-gray-700 text-white p-2 rounded-lg focus:outline-none focus:ring-2 focus:ring-amber-500"><option>No devices found</option></select></div>
                     <div class="w-24"><label for="midi-output-channel" class="block mb-1 font-medium">Channel:</label><select id="midi-output-channel" class="w-full bg-gray-700 text-white p-2 rounded-lg focus:outline-none focus:ring-2 focus:ring-amber-500"></select></div>
                </div>
            </div>
        </div>
    </div>
    
    <div id="step-editor" class="editor-popup absolute z-20 bg-gray-700 p-4 rounded-lg shadow-2xl hidden opacity-0 transform scale-95" data-row="-1" data-col="-1"><div class="flex justify-between items-center mb-3"><h3 class="font-bold text-lg">Edit Step</h3><button id="close-step-editor-btn" class="text-gray-400 hover:text-white text-2xl leading-none">&times;</button></div><div class="space-y-4"><div class="flex items-center justify-between"><label for="step-active-toggle" class="font-medium">Active</label><input type="checkbox" id="step-active-toggle" class="form-checkbox h-5 w-5 text-amber-500 bg-gray-800 border-gray-600 rounded focus:ring-amber-500"></div><div><label for="velocity-slider" class="block font-medium mb-1">Velocity</label><input type="range" id="velocity-slider" min="0" max="100" value="100" class="w-full"></div><div><label class="block font-medium mb-2">Ratchet</label><div id="ratchet-controls" class="grid grid-cols-4 gap-2"><button data-value="1" class="ratchet-btn bg-gray-600 hover:bg-gray-500 rounded p-2">1x</button><button data-value="2" class="ratchet-btn bg-gray-600 hover:bg-gray-500 rounded p-2">2x</button><button data-value="3" class="ratchet-btn bg-gray-600 hover:bg-gray-500 rounded p-2">3x</button><button data-value="4" class="ratchet-btn bg-gray-600 hover:bg-gray-500 rounded p-2">4x</button></div></div></div></div>
    
    <div id="track-editor" class="editor-popup absolute z-20 bg-gray-700 p-4 rounded-lg shadow-2xl hidden opacity-0 transform scale-95 w-64" data-row="-1"><div class="flex justify-between items-center mb-3"><h3 id="track-editor-title" class="font-bold text-lg">Track</h3><button id="close-track-editor-btn" class="text-gray-400 hover:text-white text-2xl leading-none">&times;</button></div><div id="track-editor-controls" class="space-y-3"></div></div>

    <script type="module">
        const NUM_TRACKS = 12, TOTAL_STEPS = 16, LONG_PRESS_DURATION = 400, REPEAT_LENGTH = 4;
        let trackNames = ["Kick", "Snare", "Closed Hat", "Clap", "Open Hat", "Low Tom", "Rimshot", "Cowbell", "Mid Tom", "Hi Tom", "Shaker", "Conga"];
        const MIDI_NOTES = [ 36, 38, 42, 39, 46, 41, 37, 56, 45, 48, 70, 63 ]; 

        const dom = {
            startupModal: document.getElementById('startup-modal'), startButton: document.getElementById('start-button'),
            sequencerContainer: document.getElementById('sequencer-container'), gridContainer: document.getElementById('sequencer-grid'),
            playStopButton: document.getElementById('play-stop-button'), bpmSlider: document.getElementById('bpm-slider'), bpmDisplay: document.getElementById('bpm-display'),
            mutateButton: document.getElementById('mutate-button'), recordButton: document.getElementById('record-button'), saveMidiButton: document.getElementById('save-midi-button'),
            loadMidiButton: document.getElementById('load-midi-button'), midiFileInput: document.getElementById('midi-file-input'),
            beatRepeatButton: document.getElementById('beat-repeat-button'),
            midi: { status: document.getElementById('midi-status'), inputSelect: document.getElementById('midi-input-select'), outputSelect: document.getElementById('midi-output-select'), inputChannel: document.getElementById('midi-input-channel'), outputChannel: document.getElementById('midi-output-channel'), },
            stepEditor: { root: document.getElementById('step-editor'), closeBtn: document.getElementById('close-step-editor-btn'), activeToggle: document.getElementById('step-active-toggle'), velocitySlider: document.getElementById('velocity-slider'), ratchetControls: document.getElementById('ratchet-controls'), },
            trackEditor: { root: document.getElementById('track-editor'), closeBtn: document.getElementById('close-track-editor-btn'), controlsContainer: document.getElementById('track-editor-controls'), title: document.getElementById('track-editor-title'), },
            effects: { vinylDrive: document.getElementById('vinyl-drive-slider'), filterFreq: document.getElementById('filter-freq-slider'), filterRes: document.getElementById('filter-res-slider'), delayTime: document.getElementById('delay-time-select'), delayFeedback: document.getElementById('delay-feedback-slider'), delayWet: document.getElementById('delay-wet-slider'), reverbDecay: document.getElementById('reverb-decay-slider'), reverbWet: document.getElementById('reverb-wet-slider'), }
        };

        let soundSources = [], trackFxChains = [], gridState = [], midiAccess = null, selectedMidiInput = null, selectedMidiOutput = null, isInitialized = false, pressTimer = null, currentStep = 0;
        let selectedMidiInputChannel = 'all', selectedMidiOutputChannel = 1;
        let fx = {};
        let isRecordingActive = false;
        let synthParams = [];

        async function initialize() {
            if (isInitialized) return;
            isInitialized = true;
            await Tone.start();
            initializeGridState();
            setupAudioRouting();
            populateMidiChannels();
            renderGrid();
            setupEventListeners();
            initializeMIDI();
            
            new Tone.Sequence((time, col) => {
                currentStep = col;
                Tone.Draw.schedule(() => updatePlayhead(col), time);
                for (let row = 0; row < NUM_TRACKS; row++) { if (gridState[row][col].active) playStep(row, gridState[row][col], time); }
            }, Array.from({ length: TOTAL_STEPS }, (_, i) => i), "16n").start(0);
            
            Tone.Transport.loop = true; Tone.Transport.loopEnd = '1m';
            Tone.Transport.bpm.value = dom.bpmSlider.value;
            
            dom.startupModal.style.display = 'none';
            dom.sequencerContainer.style.display = 'block';
        }
        
        function initializeGridState() {
             for (let row = 0; row < NUM_TRACKS; row++) {
                gridState[row] = Array.from({length: TOTAL_STEPS}, () => ({ active: false, velocity: 1.0, ratchet: 1 }));
            }
        }
        
        function setupAudioRouting() {
            // Global (Send) Effects
            fx.reverb = new Tone.Reverb(2).toDestination();
            fx.delay = new Tone.PingPongDelay("8n", 0.25).toDestination();
            
            // Global (Insert) Effects
            fx.distortion = new Tone.Distortion(0);
            fx.masterFilter = new Tone.Filter(20000, "lowpass");
            const masterChain = new Tone.Channel(0).chain(fx.masterFilter, fx.distortion, Tone.Destination);

            // Per-track chains
            trackFxChains = Array(NUM_TRACKS).fill(null).map(() => {
                const channel = new Tone.Channel(0).connect(masterChain);
                const filter = new Tone.Filter(20000, 'lowpass').connect(channel);
                const reverbSend = new Tone.Gain(0).connect(fx.reverb);
                const delaySend = new Tone.Gain(0).connect(fx.delay);
                
                channel.connect(delaySend);
                channel.connect(reverbSend);

                return { channel, filter, delaySend, reverbSend };
            });

            createDefaultSynths();
        }

        function createDefaultSynths() {
            soundSources = trackFxChains.map((track, i) => {
                let synth;
                let params = {};
                switch (i) {
                    case 0: params = { pitchDecay: 0.05, octaves: 10, oscillator: { type: "sine" }, envelope: { attack: 0.001, decay: 0.4, sustain: 0.01, release: 1.4, attackCurve: "exponential" } }; synth = new Tone.MembraneSynth(params); break;
                    case 1: params = { noise: { type: "white" }, envelope: { attack: 0.001, decay: 0.1, sustain: 0, release: 0.1 }, filter: { type: 'highpass', Q: 1, frequency: 100 }, filterEnvelope: { attack: 0.005, decay: 0.05, baseFrequency: 3000 } }; synth = new Tone.NoiseSynth(params); break;
                    case 2: params = { frequency: 200, envelope: { attack: 0.001, decay: 0.1, release: 0.05 }, harmonicity: 5.1, modulationIndex: 32, resonance: 8000, octaves: 1.5 }; synth = new Tone.MetalSynth(params); break;
                    case 3: params = { noise: { type: "pink" }, envelope: { attack: 0.001, decay: 0.05, sustain: 0, release: 0.05 }, filter: { type: 'highpass', Q: 1, frequency: 100 } }; synth = new Tone.NoiseSynth(params); break;
                    case 4: params = { frequency: 200, envelope: { attack: 0.001, decay: 0.4, release: 0.2 }, harmonicity: 5.1, modulationIndex: 32, resonance: 8000, octaves: 1.5 }; synth = new Tone.MetalSynth(params); break;
                    case 5: params = { pitchDecay: 0.05, octaves: 6, oscillator: { type: "sine" }, envelope: { attack: 0.001, decay: 0.3, sustain: 0.01, release: 1 }, note: "A2" }; synth = new Tone.MembraneSynth(params); break;
                    case 6: params = { attackNoise: 1, dampening: 4000, resonance: 0.7, note: "C5" }; synth = new Tone.PluckSynth(params); break;
                    case 7: params = { frequency: 300, envelope: { attack: 0.001, decay: 0.4, release: 0.2 }, harmonicity: 3.1, modulationIndex: 20, resonance: 4000, octaves: 1.5 }; synth = new Tone.MetalSynth(params); break;
                    case 8: params = { pitchDecay: 0.05, octaves: 6, oscillator: { type: "sine" }, envelope: { attack: 0.001, decay: 0.3, sustain: 0.01, release: 1 }, note: "D3" }; synth = new Tone.MembraneSynth(params); break;
                    case 9: params = { pitchDecay: 0.05, octaves: 6, oscillator: { type: "sine" }, envelope: { attack: 0.001, decay: 0.2, sustain: 0.01, release: 0.8 }, note: "G3" }; synth = new Tone.MembraneSynth(params); break;
                    case 10: params = { noise: { type: 'brown' }, envelope: { attack: 0.01, decay: 0.15, sustain: 0.05, release: 0.1 }, filter: {type: 'lowpass', frequency: 5000} }; synth = new Tone.NoiseSynth(params); break;
                    case 11: params = { pitchDecay: 0.02, octaves: 4, envelope: { attack: 0.002, decay: 0.15, sustain: 0, release: 0.1 }, note: 'G#3'}; synth = new Tone.MembraneSynth(params); break;
                    default: params = {}; synth = new Tone.MembraneSynth(params); break;
                }
                synthParams[i] = params;
                return synth.connect(track.filter);
            });
        }
        
        function populateMidiChannels() {
            dom.midi.inputChannel.innerHTML = '<option value="all">All</option>';
            dom.midi.outputChannel.innerHTML = '';
            for (let i = 1; i <= 16; i++) {
                dom.midi.inputChannel.innerHTML += `<option value="${i}">${i}</option>`;
                dom.midi.outputChannel.innerHTML += `<option value="${i}">${i}</option>`;
            }
        }

        function playStep(row, step, time) {
            const source = soundSources[row];
            if (!source && !selectedMidiOutput) return;

            const sixteenthNoteDuration = Tone.Time('16n').toSeconds(), ratchetDuration = sixteenthNoteDuration / step.ratchet, noteDuration = '32n';
            const midiVelocity = Math.floor(step.velocity * 127);
            
            for (let i = 0; i < step.ratchet; i++) {
                const playTime = time + i * ratchetDuration;
                if (source) {
                    if (source instanceof Tone.Sampler) {
                        source.triggerAttackRelease('C2', noteDuration, playTime, step.velocity);
                    } else if (source instanceof Tone.NoiseSynth) {
                         source.triggerAttackRelease(noteDuration, playTime, step.velocity);
                    } else { // Membrane, Metal, Pluck synths
                        const note = synthParams[row].note || MIDI_NOTES[row];
                        source.triggerAttackRelease(note, noteDuration, playTime, step.velocity);
                    }
                }
                if (selectedMidiOutput) {
                    const noteOn = 0x90 + (selectedMidiOutputChannel - 1);
                    const noteOff = 0x80 + (selectedMidiOutputChannel - 1);
                    selectedMidiOutput.send([noteOn, MIDI_NOTES[row], midiVelocity], playTime * 1000);
                    selectedMidiOutput.send([noteOff, MIDI_NOTES[row], 0], (playTime + Tone.Time(noteDuration).toSeconds()) * 1000);
                }
            }
        }

        function renderGrid() {
            dom.gridContainer.innerHTML = '';
            for (let row = 0; row < NUM_TRACKS; row++) {
                const trackInfoCell = document.createElement('div');
                trackInfoCell.className = 'flex items-center gap-2 pr-2 font-sans';
                const volumeButton = document.createElement('button');
                volumeButton.className = 'volume-btn p-1 rounded-md hover:bg-gray-600 transition-colors';
                volumeButton.dataset.row = row;
                volumeButton.innerHTML = `<svg class="w-6 h-6 text-gray-400 pointer-events-none" fill="currentColor" viewBox="0 0 20 20"><path d="M7 3a1 1 0 000 2v6a1 1 0 100 2h0a1 1 0 100 2v3a1 1 0 002 0v-3a1 1 0 100-2h0a1 1 0 100-2V5a1 1 0 00-2 0zM12 5a1 1 0 011-1h.01a1 1 0 110 2H13a1 1 0 01-1-1z"/></svg>`;
                volumeButton.addEventListener('click', (e) => openTrackEditor(e.currentTarget));
                trackInfoCell.appendChild(volumeButton);
                const trackLabelDiv = document.createElement('div');
                trackLabelDiv.className = 'flex flex-col items-start justify-center flex-grow';
                const trackName = document.createElement('div');
                trackName.textContent = trackNames[row];
                trackName.className = 'font-semibold text-sm truncate cursor-pointer hover:text-cyan-400';
                trackName.dataset.row = row;
                trackName.addEventListener('dblclick', handleRenameStart);
                trackLabelDiv.appendChild(trackName);
                const fileInput = document.createElement('input');
                fileInput.type = 'file'; fileInput.accept = 'audio/wav';
                fileInput.className = 'text-xs w-full mt-1'; fileInput.dataset.row = row;
                fileInput.addEventListener('change', handleFileLoad);
                trackLabelDiv.appendChild(fileInput);
                trackInfoCell.appendChild(trackLabelDiv);
                dom.gridContainer.appendChild(trackInfoCell);
                updateControl(`volume-track-${row}`, 85);

                for (let col = 0; col < TOTAL_STEPS; col++) {
                    const stepButton = document.createElement('button');
                    stepButton.className = 'step h-12 bg-gray-700 rounded-md text-xs font-bold';
                    stepButton.dataset.row = row; stepButton.dataset.col = col;
                    dom.gridContainer.appendChild(stepButton);
                    updateStepVisuals(row, col);
                }
            }
        }

        function updatePlayhead(col) {
            dom.gridContainer.querySelectorAll('.current').forEach(el => el.classList.remove('current'));
            dom.gridContainer.querySelectorAll(`[data-col="${col}"]`).forEach(button => button.classList.add('current'));
        }

        function setupEventListeners() {
            dom.playStopButton.addEventListener('click', () => {
                const isPlaying = Tone.Transport.state === 'started';
                isPlaying ? Tone.Transport.stop() : Tone.Transport.start();
                dom.playStopButton.textContent = isPlaying ? 'Play' : 'Stop';
                dom.playStopButton.classList.toggle('bg-red-500', !isPlaying); dom.playStopButton.classList.toggle('hover:bg-red-600', !isPlaying);
                dom.playStopButton.classList.toggle('bg-green-500', isPlaying); dom.playStopButton.classList.toggle('hover:bg-green-600', isPlaying);
            });
            dom.bpmSlider.addEventListener('input', e => updateControl('bpm-slider', e.target.value));
            
            const clearPressTimer = () => clearTimeout(pressTimer);
            const handlePressStart = (e) => { if (e.target.matches('.step')) { if(e.type === 'touchstart') e.preventDefault(); pressTimer = setTimeout(() => openStepEditor(e.target), LONG_PRESS_DURATION); } };
            const handlePressEnd = (e) => { if (e.target.matches('.step') && pressTimer) { clearPressTimer(); toggleStep(e.target); } };
            dom.gridContainer.addEventListener('mousedown', handlePressStart);
            dom.gridContainer.addEventListener('mouseup', handlePressEnd);
            dom.gridContainer.addEventListener('mouseleave', clearPressTimer, true);
            dom.gridContainer.addEventListener('touchstart', handlePressStart, {passive: false});
            dom.gridContainer.addEventListener('touchend', handlePressEnd);
            dom.gridContainer.addEventListener('touchmove', clearPressTimer);

            dom.stepEditor.closeBtn.addEventListener('click', closeStepEditor);
            dom.stepEditor.activeToggle.addEventListener('change', handleEditorChange);
            dom.stepEditor.velocitySlider.addEventListener('input', handleEditorChange);
            dom.stepEditor.ratchetControls.addEventListener('click', (e) => { if (e.target.matches('button')) { dom.stepEditor.ratchetControls.querySelector('.selected')?.classList.remove('selected'); e.target.classList.add('selected'); handleEditorChange(); } });
            
            dom.trackEditor.closeBtn.addEventListener('click', closeTrackEditor);
            
            dom.mutateButton.addEventListener('click', handleMutate);
            dom.recordButton.addEventListener('click', toggleRecording);
            dom.saveMidiButton.addEventListener('click', exportMidi);
            dom.loadMidiButton.addEventListener('click', () => dom.midiFileInput.click());
            dom.midiFileInput.addEventListener('change', handleMidiFileLoad);
            
            dom.beatRepeatButton.addEventListener('pointerdown', handleBeatRepeatStart);
            dom.beatRepeatButton.addEventListener('pointerup', handleBeatRepeatEnd);
            dom.beatRepeatButton.addEventListener('pointerleave', handleBeatRepeatEnd);

            Object.values(dom.effects).forEach(el => el.addEventListener('input', e => updateControl(e.target.id, e.target.tagName === 'SELECT' ? e.target.value : parseFloat(e.target.value))));
        }
        
        function handleRenameStart(e) {
            const trackNameDiv = e.target; const row = parseInt(trackNameDiv.dataset.row); const currentName = trackNames[row];
            const input = document.createElement('input'); input.type = 'text'; input.value = currentName; input.className = 'bg-gray-600 text-white text-sm font-semibold rounded px-1 w-full';
            const confirmRename = () => { const newName = input.value.trim() || `Track ${row + 1}`; trackNames[row] = newName; trackNameDiv.textContent = newName; trackNameDiv.style.display = ''; input.replaceWith(trackNameDiv); };
            input.addEventListener('blur', confirmRename);
            input.addEventListener('keydown', (e) => { if (e.key === 'Enter') input.blur(); if (e.key === 'Escape') { input.value = currentName; input.blur(); } });
            trackNameDiv.style.display = 'none'; trackNameDiv.parentElement.insertBefore(input, trackNameDiv); input.focus(); input.select();
        }

        function handleMutate() {
            for (let r = 0; r < NUM_TRACKS; r++) { for (let c = 0; c < TOTAL_STEPS; c++) { if (Math.random() > 0.85) gridState[r][c].active = !gridState[r][c].active; if (gridState[r][c].active) { if (Math.random() > 0.8) gridState[r][c].velocity = Math.random() * 0.7 + 0.3; if (Math.random() > 0.9) gridState[r][c].ratchet = Math.floor(Math.random() * 2) + 1; } } }
            renderGrid();
        }

        function toggleStep(stepElement) {
            const { row, col } = stepElement.dataset;
            gridState[row][col].active = !gridState[row][col].active;
            updateStepVisuals(parseInt(row), parseInt(col));
        }

        function openStepEditor(stepElement) {
            pressTimer = null; 
            const { root, activeToggle, velocitySlider, ratchetControls } = dom.stepEditor;
            const { row, col } = stepElement.dataset; root.dataset.row = row; root.dataset.col = col;
            const stepData = gridState[row][col];
            activeToggle.checked = stepData.active; velocitySlider.value = stepData.velocity * 100;
            ratchetControls.querySelector('.selected')?.classList.remove('selected');
            ratchetControls.querySelector(`[data-value="${stepData.ratchet}"]`).classList.add('selected');
            const rect = stepElement.getBoundingClientRect();
            root.style.left = `${Math.min(rect.left + window.scrollX, window.innerWidth - root.offsetWidth - 20)}px`;
            root.style.top = `${rect.bottom + window.scrollY + 5}px`;
            root.classList.remove('hidden'); setTimeout(() => root.classList.remove('opacity-0', 'scale-95'), 10);
        }
        function closeStepEditor() { dom.stepEditor.root.classList.add('opacity-0', 'scale-95'); setTimeout(() => dom.stepEditor.root.classList.add('hidden'), 150); }

        function openTrackEditor(volumeButton) {
            const { root, controlsContainer, title } = dom.trackEditor;
            const row = parseInt(volumeButton.dataset.row);
            root.dataset.row = row;
            title.textContent = `${trackNames[row]} Controls`;
            controlsContainer.innerHTML = ''; 
            
            const source = soundSources[row];
            const trackChain = trackFxChains[row];

            const gainInDb = trackChain.channel.volume.value;
            const sliderValue = Math.max(0, ((gainInDb + 48) / 48) * 100);
            const volControl = createSliderControl(`volume-track-${row}`, 'Level', 0, 100, sliderValue, (val) => updateControl(`volume-track-${row}`, val));
            controlsContainer.appendChild(volControl);

            controlsContainer.appendChild(createDivider('Per-Track Effects'));
            const reverbControl = createSliderControl(`track-reverb-${row}`, 'Reverb', 0, 100, trackChain.reverbSend.gain.value * 100, (val) => updateControl(`track-reverb-${row}`, val));
            controlsContainer.appendChild(reverbControl);
            
            if (source && !(source instanceof Tone.Sampler)) {
                controlsContainer.appendChild(createDivider('Synth Parameters'));
                const currentSynthParams = synthParams[row];
                if(source instanceof Tone.MembraneSynth) {
                    const currentPitch = currentSynthParams.note;
                    const tuneVal = scale(Tone.Frequency(currentPitch).toMidi(), 30, 80, 0, 100);
                    controlsContainer.appendChild(createSliderControl(`synth-tune-${row}`, 'Tune', 0, 100, tuneVal, (val) => updateControl(`synth-tune-${row}`, val)));
                    const decayVal = currentSynthParams.envelope.decay * 100;
                    controlsContainer.appendChild(createSliderControl(`synth-decay-${row}`, 'Decay', 0, 100, decayVal, (val) => updateControl(`synth-decay-${row}`, val)));
                } else if (source instanceof Tone.NoiseSynth) {
                     const decayVal = currentSynthParams.envelope.decay * 100;
                    controlsContainer.appendChild(createSliderControl(`synth-decay-${row}`, 'Decay', 0, 100, decayVal, (val) => updateControl(`synth-decay-${row}`, val)));
                } else if (source instanceof Tone.MetalSynth) {
                     const harmVal = currentSynthParams.harmonicity * 10;
                    controlsContainer.appendChild(createSliderControl(`synth-harmonicity-${row}`, 'Harmonicity', 1, 100, harmVal, (val) => updateControl(`synth-harmonicity-${row}`, val)));
                }
            }
            const rect = volumeButton.getBoundingClientRect();
            root.style.left = `${rect.left + window.scrollX}px`;
            root.style.top = `${rect.bottom + window.scrollY + 5}px`;
            root.classList.remove('hidden');
            setTimeout(() => root.classList.remove('opacity-0', 'scale-95'), 10);
        }

        function createSliderControl(id, label, min, max, value, callback) {
            const container = document.createElement('div');
            container.className = 'flex items-center gap-2';
            container.innerHTML = `<label class="w-20">${label}</label><input type="range" id="${id}" min="${min}" max="${max}" value="${value}" class="w-full">`;
            container.querySelector('input').addEventListener('input', (e) => callback(e.target.value));
            return container;
        }

        function createDropdownControl(id, label, options, value, callback) {
            const container = document.createElement('div');
            container.className = 'flex items-center gap-2';
            let optionsHTML = options.map(opt => `<option value="${opt}" ${opt === value ? 'selected' : ''}>${opt}</option>`).join('');
            container.innerHTML = `<label class="w-20">${label}</label><select id="${id}" class="bg-gray-600 rounded p-1 w-full">${optionsHTML}</select>`;
            container.querySelector('select').addEventListener('change', (e) => callback(e.target.value));
            return container;
        }
        
        function createDivider(text) {
            const container = document.createElement('div');
            container.className = 'text-center text-xs text-gray-400 font-bold uppercase tracking-wider py-1 border-t border-b border-gray-600 mt-2 mb-2';
            container.textContent = text;
            return container;
        }

        function closeTrackEditor() { dom.trackEditor.root.classList.add('opacity-0', 'scale-95'); setTimeout(() => dom.trackEditor.root.classList.add('hidden'), 150); }

        function handleEditorChange() {
            const { root, activeToggle, velocitySlider, ratchetControls } = dom.stepEditor;
            const row = parseInt(root.dataset.row), col = parseInt(root.dataset.col);
            if (row < 0 || col < 0) return;
            gridState[row][col] = { active: activeToggle.checked, velocity: parseInt(velocitySlider.value) / 100, ratchet: parseInt(ratchetControls.querySelector('.selected').dataset.value) };
            updateStepVisuals(row, col);
        }
        
        function updateStepVisuals(row, col) {
            const step = gridState[row][col];
            const stepButton = dom.gridContainer.querySelector(`[data-row="${row}"][data-col="${col}"]`);
            if (!stepButton) return;
            stepButton.classList.toggle('active', step.active);
            stepButton.style.opacity = step.active ? step.velocity * 0.7 + 0.3 : 0.5;
            stepButton.textContent = step.ratchet > 1 ? `${step.ratchet}x` : '';
        }

        async function handleFileLoad(event) {
            const file = event.target.files[0]; const row = parseInt(event.target.dataset.row);
            if (!file || isNaN(row)) return;
            const url = URL.createObjectURL(file);
            try {
                soundSources[row]?.dispose(); // Dispose of the old synth
                soundSources[row] = new Tone.Sampler({ urls: { C2: url },
                    onload: () => { 
                        trackNames[row] = file.name.replace(/\.wav$/i, '').substring(0, 12);
                        const trackNameDiv = dom.gridContainer.querySelector(`div[data-row="${row}"]`);
                        if(trackNameDiv) trackNameDiv.textContent = trackNames[row];
                        soundSources[row].connect(trackFxChains[row].channel);
                    }
                });
            } catch (error) { console.error("Error loading audio file:", error); }
        }

        function toggleRecording() { isRecordingActive = !isRecordingActive; dom.recordButton.classList.toggle('recording', isRecordingActive); }
        function handleBeatRepeatStart() { dom.beatRepeatButton.classList.add('active'); const repeatStartStep = Math.floor(currentStep / REPEAT_LENGTH) * REPEAT_LENGTH; Tone.Transport.loopStart = `0:0:${repeatStartStep}`; Tone.Transport.loopEnd = `0:0:${repeatStartStep + REPEAT_LENGTH}`; }
        function handleBeatRepeatEnd() { dom.beatRepeatButton.classList.remove('active'); Tone.Transport.loopStart = 0; Tone.Transport.loopEnd = '1m'; }

        const scale = (v, iMn, iMx, oMn, oMx) => ((v - iMn) * (oMx - oMn)) / (iMx - iMn) + oMn;

        function updateControl(controlId, value) {
            if (controlId.startsWith('volume-track-')) {
                const trackIndex = parseInt(controlId.replace('volume-track-', ''));
                const gain = scale(value, 0, 100, -48, 0); 
                if(trackFxChains[trackIndex]) trackFxChains[trackIndex].channel.volume.value = gain;
                return;
            }
            if(controlId.startsWith('track-')) {
                const [_, param, row] = controlId.split('-');
                const fxChain = trackFxChains[row];
                let numValue = parseFloat(value);
                 switch(param) {
                    case 'reverb': fxChain.reverbSend.gain.value = scale(numValue, 0, 100, 0, 1); break;
                 }
                 return;
            }
            if (controlId.startsWith('synth-')) {
                const [_, param, row] = controlId.split('-');
                const synth = soundSources[row];
                if (!synth || synth instanceof Tone.Sampler) return;
                
                let numValue = parseFloat(value);
                let paramsToSet = {};

                switch(param) {
                    case 'tune':
                        const midiNote = scale(numValue, 0, 100, 30, 80);
                        const newNote = Tone.Frequency(midiNote, 'midi').toNote();
                        synth.set({note: newNote});
                        synthParams[row].note = newNote;
                        break;
                    case 'decay': paramsToSet = { envelope: { decay: numValue / 100 } }; synthParams[row].envelope.decay = numValue / 100; break;
                }
                 if(Object.keys(paramsToSet).length > 0) synth.set(paramsToSet);
                return;
            }

            switch(controlId) {
                case 'bpm-slider': Tone.Transport.bpm.value = value; dom.bpmDisplay.textContent = Math.round(value); break;
                case 'vinyl-drive-slider': fx.distortion.distortion = value; break;
                case 'filter-freq-slider': fx.masterFilter.frequency.value = value; break;
                case 'filter-res-slider': fx.masterFilter.Q.value = value; break;
                case 'ringmod-freq-slider': fx.ringMod.frequency.value = value; break;
                case 'ringmod-wet-slider': fx.ringMod.wet.value = value; break;
                case 'freeverb-room-slider': fx.freeverb.roomSize.value = value; break;
                case 'freeverb-wet-slider': fx.freeverb.wet.value = value; break;
            }
        }
        
        async function handleMidiFileLoad(e) {
            const file = e.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = async (event) => {
                try {
                    const midi = new Midi(event.target.result);
                    initializeGridState(); // Clear the grid
                    const sixteenthNoteDuration = Tone.Time('16n').toSeconds();
                    
                    if (midi.tracks.length > 0) {
                        midi.tracks[0].notes.forEach(note => {
                            const trackIndex = MIDI_NOTES.indexOf(note.midi);
                            if (trackIndex > -1) {
                                const stepIndex = Math.round(note.time / sixteenthNoteDuration);
                                if (stepIndex < TOTAL_STEPS) {
                                    gridState[trackIndex][stepIndex] = {
                                        active: true,
                                        velocity: note.velocity,
                                        ratchet: 1
                                    };
                                }
                            }
                        });
                    }
                    renderGrid();
                } catch(err) {
                    console.error("Error parsing MIDI file:", err);
                    alert("Could not parse the selected MIDI file.");
                }
            };
            reader.readAsArrayBuffer(file);
        }

        async function exportMidi() {
             if (typeof Midi === 'undefined') {
                alert('MIDI library not loaded. Cannot export MIDI.');
                return;
            }
            try {
                const midi = new Midi();
                midi.header.setTempo(parseInt(dom.bpmSlider.value));
                
                const track = midi.addTrack();
                track.name = "Bea7s_ Pattern";
                
                for(let i=0; i < NUM_TRACKS; i++) {
                    for(let j=0; j < TOTAL_STEPS; j++) {
                        const step = gridState[i][j];
                        if (step.active) {
                            const sixteenthNoteDuration = Tone.Time('16n').toSeconds();
                            const ratchetDuration = sixteenthNoteDuration / step.ratchet;
                            for (let k = 0; k < step.ratchet; k++) {
                               const noteTime = (j * sixteenthNoteDuration) + (k * ratchetDuration);
                               track.addNote({
                                    midi: MIDI_NOTES[i],
                                    time: noteTime,
                                    duration: ratchetDuration,
                                    velocity: step.velocity
                               });
                            }
                        }
                    }
                }

                const blob = new Blob([midi.toArray()], { type: 'audio/midi' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `Bea7s_Pattern_${Date.now()}.mid`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            } catch (err) {
                 console.error("MIDI Export failed:", err);
                 alert("An error occurred while exporting the MIDI file.");
            }
        }

        async function initializeMIDI() {
            if (!navigator.requestMIDIAccess) { dom.midi.status.textContent = 'Web MIDI API not supported.'; return; }
            try {
                midiAccess = await navigator.requestMIDIAccess();
                dom.midi.status.textContent = 'MIDI Ready.'; dom.midi.status.style.color = '#34d399';
                const updateDevices = () => {
                    dom.midi.inputSelect.innerHTML = '<option value="">None</option>' + [...midiAccess.inputs.values()].map(d => `<option value="${d.id}">${d.name}</option>`).join('');
                    dom.midi.outputSelect.innerHTML = '<option value="">None</option>' + [...midiAccess.outputs.values()].map(d => `<option value="${d.id}">${d.name}</option>`).join('');
                };
                updateDevices();
                midiAccess.onstatechange = updateDevices;
                dom.midi.inputSelect.onchange = e => { if (selectedMidiInput) selectedMidiInput.onmidimessage = null; selectedMidiInput = midiAccess.inputs.get(e.target.value) || null; if (selectedMidiInput) selectedMidiInput.onmidimessage = handleMidiMessage; };
                dom.midi.outputSelect.onchange = e => { selectedMidiOutput = midiAccess.outputs.get(e.target.value) || null; };
                dom.midi.inputChannel.onchange = e => { selectedMidiInputChannel = e.target.value === 'all' ? 'all' : parseInt(e.target.value); };
                dom.midi.outputChannel.onchange = e => { selectedMidiOutputChannel = parseInt(e.target.value); };
            } catch(e) { dom.midi.status.textContent = 'Could not access MIDI devices.'; dom.midi.status.style.color = '#f87171'; }
        }

        function handleMidiMessage(message) {
            const [command, data1, data2] = message.data;
            const cmd = command & 0xF0;
            const channel = (command & 0x0F) + 1;
            
            if (selectedMidiInputChannel !== 'all' && channel !== selectedMidiInputChannel) {
                return;
            }

            if (cmd === 144 && data2 > 0) { // Note On
                const trackIndex = MIDI_NOTES.indexOf(data1);
                if (trackIndex > -1) {
                    if (isRecordingActive) {
                        gridState[trackIndex][currentStep] = { active: true, velocity: data2/127, ratchet: 1 };
                        updateStepVisuals(trackIndex, currentStep);
                    }
                    const source = soundSources[trackIndex];
                    if (source instanceof Tone.Sampler) {
                        source.triggerAttack('C2', Tone.now(), data2 / 127);
                    } else if (source) {
                         if (source instanceof Tone.NoiseSynth){
                            source.triggerAttack(undefined, Tone.now(), data2 / 127);
                         } else {
                            source.triggerAttack(synthParams[trackIndex].note || MIDI_NOTES[trackIndex], Tone.now(), data2 / 127);
                         }
                    }
                }
            }
        }

        dom.startButton.addEventListener('click', initialize);
        dom.startupModal.addEventListener('click', e => { if (e.target === dom.startupModal) initialize(); });
    </script>
</body>
</html>

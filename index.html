<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Bea7s_</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            /* Flat Modern Theme */
            --bg-color: #1a202c; /* Slate 900 */
            --controls-color: #2d3748; /* Slate 800 */
            --track-header-color: #4a5568; /* Slate 700 */
            --step-off-color: #718096; /* Slate 500 */
            --primary-color: #4299e1; /* Blue 500 */
            --secondary-color: #9f7aea; /* Purple 500 */
            --step-on-color: var(--primary-color);
            --step-active-color: #ffffff;
            --text-color: #edf2f7; /* Slate 200 */
            --record-armed-color: #e53e3e; /* Red 600 */
        }
        html, body {
            height: 100vh; width: 100vw; margin: 0; padding: 0;
            background-color: var(--bg-color);
            overflow: hidden;
        }
        body {
            font-family: 'Inter', sans-serif; color: var(--text-color);
            display: flex; flex-direction: column;
        }
        .main-container {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            min-height: 0;
            padding: 0.5rem;
        }
        .sequencer-wrapper {
            flex-grow: 1;
            overflow-y: auto; /* vertical scroll for the grid */
            min-height: 0;
        }
        .top-controls-wrapper {
            background-color: var(--controls-color);
            border-bottom: 1px solid #4a5568;
            padding: 0.75rem;
            flex-shrink: 0;
        }
        .bottom-controls {
            flex-shrink: 0; background-color: var(--controls-color);
            padding: 0.75rem; border-top: 1px solid #4a5568;
        }
        .sequencer-grid {
            display: grid;
            grid-template-columns: minmax(65px, 1fr) repeat(16, minmax(0, 3fr));
            gap: 4px; padding: 4px;
        }
        .step {
            transition: all 0.1s ease;
            cursor: pointer; border-radius: 4px;
            background-color: var(--step-off-color);
            border: 1px solid transparent;
        }
        .step.on {
             background-color: var(--step-on-color);
        }
        .step.ratchet-on {
            background-color: var(--secondary-color);
        }
        .step.active {
            border-color: var(--step-active-color);
            transform: scale(1.1);
        }
        .track-header {
            background-color: var(--track-header-color);
            border-radius: 4px;
        }
        .popup-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(26, 32, 44, 0.8); backdrop-filter: blur(5px);
            display: flex; justify-content: center; align-items: center; z-index: 50;
        }
        .popup {
            background-color: var(--bg-color); border: 1px solid var(--primary-color);
            border-radius: 8px; padding: 1.5rem; width: 90%; max-width: 500px;
        }
        select, button, label {
            background-color: #4a5568; border: 1px solid #718096;
            border-radius: 4px; padding: 0.5rem; color: var(--text-color);
            transition: all 0.2s ease-in-out;
        }
        button:hover, label:hover {
            border-color: var(--primary-color);
            color: white;
        }
        #play-stop {
             background-color: var(--primary-color);
             border-color: var(--primary-color);
             color: white;
        }
        #record-btn.armed {
             background-color: var(--record-armed-color);
             border-color: var(--record-armed-color);
        }
        .logo {
            font-size: 2rem;
            font-weight: 700;
            color: var(--text-color);
            text-align: center;
            margin-bottom: 0.5rem;
        }
        .logo span {
            color: var(--primary-color);
        }
    </style>
</head>
<body>

    <div id="loading-overlay" class="fixed inset-0 bg-slate-900 flex flex-col justify-center items-center z-[100] text-center p-4">
        <h1 class="logo">Bea<span>7</span>s_</h1>
        <div class="mt-8 text-left max-w-md mx-auto space-y-2">
            <h2 class="text-xl font-bold text-center mb-4">How To Use</h2>
            <p><strong class="text-blue-400">Play/Stop:</strong> Use the main Play button.</p>
            <p><strong class="text-blue-400">Toggle Step:</strong> Click a step in the grid to turn it on/off.</p>
            <p><strong class="text-blue-400">Step Options:</strong> Double-click a step for Velocity/Ratchet.</p>
            <p><strong class="text-blue-400">Track FX:</strong> Click the 'FX' button on a track for sound design.</p>
            <p><strong class="text-blue-400">Rename Track:</strong> Double-click a track name to rename it.</p>
            <p><strong class="text-blue-400">MIDI Record:</strong> Arm 'Record', then play notes on your controller.</p>
        </div>
        <p class="text-lg mt-8 mb-8">Click anywhere to start.</p>
    </div>
    
    <div class="top-controls-wrapper">
        <h1 class="logo">Bea<span>7</span>s_</h1>
        <div class="flex flex-col sm:flex-row items-center justify-between gap-4 max-w-7xl mx-auto">
             <div class="flex items-center gap-4 w-full sm:w-auto">
                <button id="play-stop" class="font-bold py-2 px-4 rounded-lg">Play</button>
                <div class="flex items-center gap-2 flex-grow">
                    <label for="bpm" class="text-sm font-medium">BPM</label>
                    <input type="range" id="bpm" min="40" max="240" value="120" class="w-full">
                    <span id="bpm-value" class="font-mono w-12 text-center text-sm">120</span>
                </div>
            </div>
             <div class="flex items-center gap-2 w-full sm:w-auto">
                <button id="record-btn" class="font-bold p-2 rounded-lg">Record</button>
                <button id="clear-btn" class="font-bold p-2 rounded-lg">Clear</button>
                <button id="mutate" class="font-bold p-2 rounded-lg">Mutate</button>
                <button id="beat-repeat-btn" class="font-bold py-2 px-4 rounded-lg w-auto">Repeat</button>
             </div>
        </div>
    </div>

    <div class="main-container w-full">
        <div class="sequencer-wrapper">
            <div id="sequencer-grid" class="sequencer-grid"></div>
        </div>
    </div>
    
    <div class="bottom-controls">
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 max-w-7xl mx-auto">
             <div class="md:col-start-2 control-group flex flex-col"><label class="text-xs" for="midi-input-device">MIDI In Device</label><select id="midi-input-device" class="w-full text-sm"></select></div>
             <div class="control-group flex flex-col"><label class="text-xs" for="midi-input-channel">MIDI In Ch</label><select id="midi-input-channel" class="w-full text-sm"></select></div>
             <div class="control-group flex flex-col"><label class="text-xs" for="midi-output-device">MIDI Out Device</label><select id="midi-output-device" class="w-full text-sm"></select></div>
             <div class="control-group flex flex-col"><label class="text-xs" for="midi-output-channel">MIDI Out Ch</label><select id="midi-output-channel" class="w-full text-sm"></select></div>
        </div>
    </div>

    <div id="track-popup" class="popup-overlay hidden"></div>
    <div id="step-popup" class="popup-overlay hidden"></div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const NUM_STEPS = 16;
            const NUM_TRACKS = 12; // CHANGE: Increased to 12 tracks
            let trackNames = ['Kick', 'Snare', 'Clap', 'Hi-Hat', 'Tom 1', 'Tom 2', 'Cymbal', 'Perc', 'Conga', 'Cowbell', 'Clave', 'Maraca'];
            
            const noteMap = { 35: 0, 36: 0, 38: 1, 40: 1, 39: 2, 42: 3, 44: 3, 46: 3, 41: 4, 43: 4, 45: 4, 47: 5, 48: 5, 50: 5, 49: 6, 51: 6, 52: 6, 55: 6, 57: 6, 59: 6, 56: 7, 63: 8, 64: 8, 56: 9, 75: 10, 70: 11 };
            const trackNotes = [36, 38, 39, 42, 45, 48, 49, 56, 64, 56, 75, 70];

            let sequenceData = [];
            let instruments = [];
            let currentStep = 0;
            let midiAccess = null;
            let activeMIDIInputId = null;
            let activeMIDIOutputId = null;
            let beatRepeatActive = false;
            let repeatEventId = null;
            let activePopupTrack = -1;
            let activeStepForPopup = { track: -1, step: -1 };
            let recordArmed = false;

            const allElements = {
                loadingOverlay: document.getElementById('loading-overlay'),
                sequencerGrid: document.getElementById('sequencer-grid'),
                playStopBtn: document.getElementById('play-stop'),
                bpmSlider: document.getElementById('bpm'),
                bpmValue: document.getElementById('bpm-value'),
                mutateBtn: document.getElementById('mutate'),
                beatRepeatBtn: document.getElementById('beat-repeat-btn'),
                recordBtn: document.getElementById('record-btn'),
                clearBtn: document.getElementById('clear-btn'),
                midiInputDevice: document.getElementById('midi-input-device'),
                midiOutputDevice: document.getElementById('midi-output-device'),
                midiInputChannel: document.getElementById('midi-input-channel'),
                midiOutputChannel: document.getElementById('midi-output-channel'),
                trackPopup: document.getElementById('track-popup'),
                stepPopup: document.getElementById('step-popup')
            };

            async function initialize() {
                await Tone.start();
                createPopupHTML();
                setupInstruments();
                createSequencerGrid();
                setupEventListeners();
                await setupMIDI();
                Tone.Transport.bpm.value = 120;
                Tone.Transport.scheduleRepeat(onStep, '16n');
                allElements.loadingOverlay.classList.add('hidden');
            }
            allElements.loadingOverlay.addEventListener('click', initialize, { once: true });
            
            function createPopupHTML() {
                 allElements.trackPopup.innerHTML = `<div class="popup"><h2 id="popup-track-name" class="text-2xl font-bold mb-4"></h2><div id="custom-synth-controls-container" class="space-y-4 mb-4"></div> <hr class="my-4 border-gray-600"> <div class="space-y-4"><div><label>Volume</label><input type="range" id="volume" min="-40" max="6" value="0" step="1"></div><div><label>Pan</label><input type="range" id="pan" min="-1" max="1" value="0" step="0.1"></div><div><label>Reverb</label><input type="range" id="reverb" min="0" max="1" value="0" step="0.01"></div><div><label>Delay</label><input type="range" id="delay" min="0" max="1" value="0" step="0.01"></div></div><button id="close-popup" class="mt-6 w-full text-lg">Close</button></div>`;
                 allElements.stepPopup.innerHTML = `<div class="popup"><h2 class="text-2xl font-bold mb-4">Step Options</h2><div class="space-y-4"><div><label for="velocity">Velocity</label><input type="range" id="velocity" min="0.1" max="1" value="1" step="0.01"></div><div><label for="ratchet">Ratchet</label><select id="ratchet" class="w-full"><option value="1">1</option><option value="2">2</option><option value="3">3</option><option value="4">4</option></select></div></div><button id="close-step-popup" class="mt-6 w-full text-lg">Close</button></div>`;
            }

            function setupInstruments() {
                const globalReverb = new Tone.Reverb(1.5).toDestination();
                const globalDelay = new Tone.FeedbackDelay("8n", 0.5).toDestination();

                const createFxChain = () => {
                    const panVol = new Tone.PanVol(0, 0);
                    const reverbSend = new Tone.Gain(0).connect(globalReverb);
                    const delaySend = new Tone.Gain(0).connect(globalDelay);
                    panVol.connect(Tone.Destination);
                    return { panVol, reverbSend, delaySend };
                };
                
                const connectToFx = (source, fx) => {
                    source.connect(fx.panVol);
                    source.connect(fx.reverbSend);
                    source.connect(fx.delaySend);
                };

                for(let i=0; i < NUM_TRACKS; i++) {
                    const fxChain = createFxChain();
                    let synth, type;
                    switch(i) {
                        case 0: // Kick
                           synth = new Tone.MembraneSynth({ pitchDecay: 0.05, octaves: 10, oscillator: { type: "sine" }, envelope: { attack: 0.001, decay: 0.4, sustain: 0.01, release: 1.4, attackCurve: "exponential" } });
                           type = 'kick';
                           break;
                        case 1: // Snare
                           synth = new Tone.NoiseSynth({ noise: { type: 'white' }, envelope: { attack: 0.005, decay: 0.2, sustain: 0 } });
                           type = 'snare';
                           break;
                        case 3: // Hi-Hat
                           synth = new Tone.MetalSynth({ frequency: 200, envelope: { attack: 0.001, decay: 0.1, release: 0.01 }, harmonicity: 5.1, modulationIndex: 32, resonance: 4000, octaves: 1.5 });
                           type = 'hihat';
                           break;
                        default: // Clap, Toms, Perc, etc.
                           synth = new Tone.PluckSynth({ attackNoise: 0.5, dampening: 4000, resonance: 0.7 });
                           type = 'generic';
                           break;
                    }
                    connectToFx(synth, fxChain);
                    instruments[i] = { name: trackNames[i], synth, fx: fxChain, player: null, source: synth, type };
                }
            }
            
            function createSequencerGrid() {
                allElements.sequencerGrid.innerHTML = '';
                for (let t = 0; t < NUM_TRACKS; t++) {
                    sequenceData[t] = [];
                    const header = document.createElement('div');
                    header.className = 'track-header flex flex-col items-center justify-center p-1 rounded text-center';
                    header.dataset.track = t;
                    header.innerHTML = `<span data-track="${t}" class="track-name font-bold truncate cursor-pointer">${trackNames[t]}</span><div class="flex gap-1 mt-1"><button data-track="${t}" class="settings-btn text-xs p-1">FX</button><input type="file" id="track-${t}-loader" class="hidden" accept=".wav"><label for="track-${t}-loader" class="text-xs p-1 cursor-pointer">Load</label></div>`;
                    allElements.sequencerGrid.appendChild(header);
                    for (let s = 0; s < NUM_STEPS; s++) {
                        sequenceData[t][s] = { on: false, velocity: 1, ratchet: 1 };
                        const e = document.createElement('div');
                        e.className = 'step';
                        e.dataset.track = t;
                        e.dataset.step = s;
                        allElements.sequencerGrid.appendChild(e);
                    }
                }
            }

            function setupEventListeners() {
                allElements.playStopBtn.addEventListener('click', togglePlayback);
                allElements.bpmSlider.addEventListener('input', (e) => { Tone.Transport.bpm.value = e.target.value; allElements.bpmValue.textContent = e.target.value; });
                allElements.sequencerGrid.addEventListener('click', handleStepClick);
                allElements.sequencerGrid.addEventListener('dblclick', handleGridDblClick);
                allElements.mutateBtn.addEventListener('click', mutateSequence);
                allElements.midiInputDevice.addEventListener('change', (e) => activeMIDIInputId = e.target.value);
                allElements.midiOutputDevice.addEventListener('change', (e) => activeMIDIOutputId = e.target.value);
                allElements.beatRepeatBtn.addEventListener('mousedown', startBeatRepeat);
                allElements.beatRepeatBtn.addEventListener('mouseup', stopBeatRepeat);
                allElements.beatRepeatBtn.addEventListener('mouseleave', stopBeatRepeat);
                allElements.beatRepeatBtn.addEventListener('touchstart', (e) => { e.preventDefault(); startBeatRepeat(); });
                allElements.beatRepeatBtn.addEventListener('touchend', (e) => { e.preventDefault(); stopBeatRepeat(); });
                allElements.recordBtn.addEventListener('click', toggleRecord);
                allElements.clearBtn.addEventListener('click', () => { clearSequence(); redrawGridFromData(); });
                allElements.trackPopup.querySelector('#close-popup').addEventListener('click', closeTrackPopup);
                allElements.stepPopup.querySelector('#close-step-popup').addEventListener('click', closeStepPopup);
                setupPopupControls();
            }

            function onStep(time) {
                const stepToPlay = currentStep;
                triggerStep(stepToPlay, time);
                Tone.Draw.schedule(() => updateActiveStepUI(stepToPlay), time);
                currentStep = (currentStep + 1) % NUM_STEPS;
            }

            function triggerStep(step, time, velocityFromMIDI = null) {
                for (let track = 0; track < NUM_TRACKS; track++) {
                    const stepData = sequenceData[track][step];
                    const triggerVelocity = velocityFromMIDI !== null ? velocityFromMIDI : stepData.velocity;
                    if (stepData.on || velocityFromMIDI !== null) {
                        const { source, type } = instruments[track];
                        const note = getNoteForTrack(track);
                        const ratchet = parseInt(stepData.ratchet);
                        
                        if (source instanceof Tone.Player) {
                            source.start(time, 0, undefined, triggerVelocity);
                            continue;
                        }

                        if (ratchet > 1) {
                            const noteDuration = Tone.Time('16n').toSeconds() / ratchet;
                            for (let i = 0; i < ratchet; i++) {
                                const ratchetTime = time + i * noteDuration;
                                if (type === 'snare') source.triggerAttack(ratchetTime, triggerVelocity);
                                else source.triggerAttackRelease(note, noteDuration, ratchetTime, triggerVelocity);
                            }
                        } else {
                            if (type === 'snare') source.triggerAttack(time, triggerVelocity);
                            else source.triggerAttackRelease(note, '16n', time, triggerVelocity);
                        }
                    }
                }
            }
            
            function handleGridDblClick(e) {
                if (e.target.classList.contains('track-name')) { renameTrack(e.target); } 
                else if (e.target.classList.contains('step')) { openStepPopup(parseInt(e.target.dataset.track), parseInt(e.target.dataset.step)); }
            }
            
            function handleStepClick(e) {
                const target = e.target;
                if (target.classList.contains('step')) { toggleStep(parseInt(target.dataset.track), parseInt(target.dataset.step)); } 
                else if (target.classList.contains('settings-btn')) { openTrackPopup(parseInt(target.dataset.track)); }
                else if (target.tagName === 'LABEL' && target.htmlFor.includes('loader')) {
                    document.getElementById(target.htmlFor).addEventListener('change', (ev) => loadSample(parseInt(target.htmlFor.split('-')[1]), ev.target.files[0]), { once: true });
                }
            }

            function renameTrack(spanElement) {
                const track = parseInt(spanElement.dataset.track);
                const input = document.createElement('input');
                input.type = 'text'; input.value = spanElement.textContent;
                input.className = 'bg-gray-700 text-white w-full text-xs text-center';
                spanElement.replaceWith(input); input.focus();
                const save = () => {
                    const newName = input.value.trim();
                    if (newName) { trackNames[track] = newName; }
                    spanElement.textContent = trackNames[track];
                    input.replaceWith(spanElement);
                };
                input.addEventListener('blur', save);
                input.addEventListener('keydown', e => { if(e.key === 'Enter') save(); });
            }
            
            function startBeatRepeat() {
                if (beatRepeatActive || Tone.Transport.state !== 'started') return;
                beatRepeatActive = true;
                const beatRepeatLength = 4;
                Tone.Transport.cancel(); 
                const startStep = Math.floor(currentStep / beatRepeatLength) * beatRepeatLength;
                let repeatSteps = Array.from({length: beatRepeatLength}, (_, i) => (startStep + i) % NUM_STEPS);
                repeatEventId = new Tone.Sequence((time, step) => {
                    triggerStep(step, time);
                    Tone.Draw.schedule(() => updateActiveStepUI(step), time);
                }, repeatSteps, "16n").start(0);
            }

            function stopBeatRepeat() {
                if (!beatRepeatActive) return;
                beatRepeatActive = false;
                if (repeatEventId) { repeatEventId.dispose(); repeatEventId = null; }
                Tone.Transport.cancel();
                Tone.Transport.scheduleRepeat(onStep, '16n');
            }
            
            function toggleRecord() {
                recordArmed = !recordArmed;
                allElements.recordBtn.classList.toggle('armed', recordArmed);
            }
            
            function getNoteForTrack(t) { return Tone.Frequency(trackNotes[t], "midi").toNote() }
            function updateActiveStepUI(s) { document.querySelectorAll('.step').forEach(e => e.classList.remove('active')); if (s > -1) document.querySelectorAll(`.step[data-step='${s}']`).forEach(e => e.classList.add('active')); }
            
            async function setupMIDI() {
                if (!navigator.requestMIDIAccess) return;
                try {
                    midiAccess = await navigator.requestMIDIAccess();
                    populateMIDIDevices();
                    midiAccess.onstatechange = populateMIDIDevices;
                } catch (e) {
                    console.error("MIDI Error:", e);
                }
            }

            function populateMIDIDevices() {
                allElements.midiInputDevice.innerHTML = '<option value="">None</option>';
                midiAccess.inputs.forEach(i => {
                    const o = new Option(i.name, i.id, false, i.id === activeMIDIInputId);
                    allElements.midiInputDevice.add(o);
                    i.onmidimessage = onMIDIMessage;
                });
                allElements.midiOutputDevice.innerHTML = '<option value="">None</option>';
                midiAccess.outputs.forEach(o => allElements.midiOutputDevice.add(new Option(o.name, o.id, false, o.id === activeMIDIOutputId)));
                if (allElements.midiInputChannel.options.length <= 1) {
                    allElements.midiInputChannel.innerHTML = '<option value="0">All</option>';
                    allElements.midiOutputChannel.innerHTML = '<option value="0">All</option>';
                    for (let i = 1; i <= 16; i++) {
                        allElements.midiInputChannel.add(new Option(i, i));
                        allElements.midiOutputChannel.add(new Option(i, i));
                    }
                    allElements.midiInputChannel.value = "10";
                    allElements.midiOutputChannel.value = "10";
                }
            }
            
            function onMIDIMessage(e) {
                if (e.target.id !== activeMIDIInputId) return;
                const [command, note, velocity] = e.data;
                const channel = (command & 0x0f) + 1;
                const cmd = command >> 4;
                const selectedChannel = parseInt(allElements.midiInputChannel.value);
                if (selectedChannel !== 0 && channel !== selectedChannel) return;
                const track = noteMap[note];
                if (track === undefined) return;

                if (cmd === 9 && velocity > 0) {
                    const toneVelocity = velocity / 127;
                    if (recordArmed && Tone.Transport.state === 'started') {
                        const ticksPerStep = Tone.Transport.PPQ / 4;
                        const recordStep = Math.floor(Tone.Transport.ticks / ticksPerStep) % NUM_STEPS;
                        sequenceData[track][recordStep] = { ...sequenceData[track][recordStep], on: true, velocity: toneVelocity };
                        redrawGridFromData();
                    }
                    triggerStep(track, Tone.now(), toneVelocity);
                }
            }
            
            function togglePlayback() { if ("started" === Tone.Transport.state) { Tone.Transport.stop(); allElements.playStopBtn.textContent = 'Play'; currentStep = 0; updateActiveStepUI(-1); } else { Tone.Transport.start(); allElements.playStopBtn.textContent = 'Stop'; } }
            
            function toggleStep(t, s) {
                const e = sequenceData[t][s];
                e.on = !e.on;
                const stepEl = document.querySelector(`.step[data-track='${t}'][data-step='${s}']`);
                stepEl.classList.toggle('on', e.on);
                stepEl.classList.toggle('ratchet-on', e.ratchet > 1 && e.on);
            }
            
            async function loadSample(trackIndex, file) {
                if (!file) return;
                const url = URL.createObjectURL(file);
                const instrument = instruments[trackIndex];

                if (instrument.player) instrument.player.dispose();
                if (instrument.synth) {
                    instrument.synth.dispose();
                    instrument.synth = null;
                }

                const player = new Tone.Player(url);
                await Tone.loaded(); 
                
                player.connect(instrument.fx.panVol);
                player.connect(instrument.fx.reverbSend);
                player.connect(instrument.fx.delaySend);

                instrument.player = player;
                instrument.source = player;
                
                const header = document.querySelector(`.track-header[data-track='${trackIndex}'] .track-name`);
                if(header) header.classList.add('text-blue-400');
            }

            function mutateSequence() { for (let t = 0; t < NUM_TRACKS; t++) for (let s = 0; s < NUM_STEPS; s++) if (Math.random() < .25) toggleStep(t, s); }
            
            function clearSequence() {
                 for (let t = 0; t < NUM_TRACKS; t++) for (let s = 0; s < NUM_STEPS; s++) {
                    sequenceData[t][s].on = false; sequenceData[t][s].velocity = 1; sequenceData[t][s].ratchet = 1;
                }
            }

            function redrawGridFromData() {
                 for (let t = 0; t < NUM_TRACKS; t++) for (let s = 0; s < NUM_STEPS; s++) {
                    const stepEl = allElements.sequencerGrid.querySelector(`.step[data-track='${t}'][data-step='${s}']`);
                    if (stepEl) {
                       stepEl.classList.toggle('on', sequenceData[t][s].on);
                       stepEl.classList.toggle('ratchet-on', sequenceData[t][s].ratchet > 1 && sequenceData[t][s].on);
                    }
                }
            }

            function openTrackPopup(trackIndex) {
                activePopupTrack = trackIndex;
                const instrument = instruments[trackIndex];
                if (!instrument) return;

                const popup = allElements.trackPopup;
                popup.querySelector("#popup-track-name").textContent = `Track: ${trackNames[trackIndex]}`;
                const customControlsContainer = popup.querySelector("#custom-synth-controls-container");
                customControlsContainer.innerHTML = '';
                let controlsHTML = '';
                
                if(instrument.source instanceof Tone.Player){
                    controlsHTML = `<p class='text-gray-400'>Sample loaded. Synth controls disabled.</p>`;
                } else {
                    const currentSynthSettings = instrument.synth.get();
                    switch (instrument.type) {
                        case 'kick':
                            controlsHTML = `<div><label>Pitch Decay</label><input type="range" data-param="pitchDecay" min="0.01" max="0.5" value="${currentSynthSettings.pitchDecay}" step="0.01"></div><div><label>Octaves</label><input type="range" data-param="octaves" min="1" max="10" value="${currentSynthSettings.octaves}" step="0.5"></div><div><label>Decay</label><input type="range" data-param="decay" min="0.01" max="1.4" value="${currentSynthSettings.envelope.decay}" step="0.01"></div>`;
                            break;
                        case 'snare':
                            controlsHTML = `<div><label>Decay</label><input type="range" data-param="decay" min="0.01" max="0.5" value="${currentSynthSettings.envelope.decay}" step="0.01"></div>`;
                            break;
                        case 'hihat':
                            controlsHTML = `<div><label>Metallic</label><input type="range" data-param="harmonicity" min="1" max="10" value="${currentSynthSettings.harmonicity}" step="0.1"></div><div><label>Resonance</label><input type="range" data-param="resonance" min="1000" max="8000" value="${currentSynthSettings.resonance}" step="100"></div>`;
                            break;
                        default:
                            controlsHTML = `<div><label>Dampening</label><input type="range" data-param="dampening" min="1000" max="7000" value="${currentSynthSettings.dampening}" step="100"></div><div><label>Resonance</label><input type="range" data-param="resonance" min="0" max="0.99" value="${currentSynthSettings.resonance}" step="0.01"></div>`;
                            break;
                    }
                }
                customControlsContainer.innerHTML = controlsHTML;
                popup.querySelector("#volume").value = instrument.fx.panVol.volume.value;
                popup.querySelector("#pan").value = instrument.fx.panVol.pan.value;
                popup.querySelector("#reverb").value = instrument.fx.reverbSend.gain.value;
                popup.querySelector("#delay").value = instrument.fx.delaySend.gain.value;
                popup.classList.remove("hidden");
            }
            
            function closeTrackPopup() { allElements.trackPopup.classList.add("hidden"); activePopupTrack = -1; }
            function openStepPopup(t, s) { activeStepForPopup = { track: t, step: s }; const e = sequenceData[t][s]; allElements.stepPopup.querySelector("#velocity").value = e.velocity; allElements.stepPopup.querySelector("#ratchet").value = e.ratchet; allElements.stepPopup.classList.remove("hidden"); }
            function closeStepPopup() { allElements.stepPopup.classList.add("hidden"); activeStepForPopup = { track: -1, step: -1 }; }
            
            function setupPopupControls() {
                allElements.trackPopup.addEventListener('input', e => {
                    if (activePopupTrack < 0) return;
                    const instrument = instruments[activePopupTrack];
                    const param = e.target.dataset.param;
                    const value = parseFloat(e.target.value);
                    if (e.target.id === 'volume') instrument.fx.panVol.volume.value = value;
                    else if (e.target.id === 'pan') instrument.fx.panVol.pan.value = value;
                    else if (e.target.id === 'reverb') instrument.fx.reverbSend.gain.value = value;
                    else if (e.target.id === 'delay') instrument.fx.delaySend.gain.value = value;
                    else if(param && !(instrument.source instanceof Tone.Player)) {
                       if (param.includes('decay') || param.includes('attack') || param.includes('sustain') || param.includes('release')) {
                           instrument.synth.set({ envelope: { [param]: value } });
                       } else if (instrument.synth[param] && typeof instrument.synth[param].value !== 'undefined') {
                           instrument.synth[param].value = value;
                       } else {
                           instrument.synth.set({ [param]: value });
                       }
                    }
                });
                allElements.stepPopup.addEventListener('input', e => {
                    const { track: t, step: s } = activeStepForPopup;
                    if(t < 0) return;
                    if(e.target.id === 'velocity') sequenceData[t][s].velocity = parseFloat(e.target.value);
                    if(e.target.id === 'ratchet') {
                        sequenceData[t][s].ratchet = parseInt(e.target.value);
                        redrawGridFromData();
                    }
                });
            }
        });
    </script>
</body>
</html>
